(function () {
    "use strict"; // optional

    //init variables to load App
    var initPubTypeSearch = 0;
    var trackPubTypeSearch = setInterval(function () { if (window.jQuery) { clearInterval(trackPubTypeSearch); StartPubTypeSearch(); } }, 10);


    function StartPubTypeSearch() {
        if (initPubTypeSearch === 1) { return; } else { initPubTypeSearch = 1; }

		var appParam = decodeURIComponent(jQuery('#pubtypesearch-app').data('p'));
		appParam = appParam.replace(/\+/g," ");
		appParam = JSON.parse(appParam);

		var appHook = jQuery('#pubtypesearch-app').data('h');
		if (appHook === undefined) { appHook = '.searching'; }

		var pubTypeItems = "";
		jQuery(appParam.type).each(function(){
			var pubTypeItem = this;
			var checkedStatus = (pubTypeItem.d)?'checked="checked"':'';
			pubTypeItems += '<label>\
									<input type="radio" '+checkedStatus+' name="pubsource-type" value="'+pubTypeItem.pt+'" aria-label="'+pubTypeItem.label+'">\
									<strong>'+pubTypeItem.label+'</strong>\
							</label>\
						  &nbsp;&nbsp;&nbsp;';
		});

		pubTypeItems = '<div id="pubtypesearch-view">' + pubTypeItems + '</div>';

		jQuery(appHook).after(pubTypeItems);


		jQuery('#aspnetForm').submit(function () {


			jQuery('[name*="SearchTerm"]').each(function(){
				var currentSearchTermBox = this;
				var submitSearchTerm = jQuery(currentSearchTermBox).attr('value');
				if(submitSearchTerm==""){return;}
				if((submitSearchTerm !== " ") && (jQuery('input[name="pubsource-type"]:checked').val()!=" ")){
					submitSearchTerm = '('+submitSearchTerm+')' + jQuery('input[name="pubsource-type"]:checked').val();
					submitSearchTerm = (submitSearchTerm.slice(-1)==" ")?submitSearchTerm.slice(0,-1):submitSearchTerm;
					jQuery(currentSearchTermBox).attr('value', submitSearchTerm);
				}
			});

		});

        //Clean Up
		var breadcrumbTerm = jQuery('a.search-terms').text();
		jQuery('[name*="SearchTerm"]').each(function(){
			var currentSearchTermBox = this;
			var submitSearchTerm = jQuery(currentSearchTermBox).val();
			if (submitSearchTerm.length>0){
				jQuery('input[name="pubsource-type"]').each(function () {
					var currentPubType = this;
					if(jQuery(currentPubType).val()!==" "){
						if (submitSearchTerm.indexOf(jQuery(currentPubType).val())>-1) {
							jQuery(currentPubType).prop("checked",true);
							submitSearchTerm = submitSearchTerm.replace(jQuery(currentPubType).val(), "");
							submitSearchTerm = submitSearchTerm.replace('(', "").slice(0, -1);

							jQuery(currentSearchTermBox).val(submitSearchTerm);
							
							breadcrumbTerm = breadcrumbTerm.replace('('+submitSearchTerm+')'+jQuery(currentPubType).val(),submitSearchTerm);
							//console.log(breadcrumbTerm);
							
						}
					}
				});
				
			}
			
		});
		
		jQuery('a.search-terms').text(breadcrumbTerm);
  }
}());
