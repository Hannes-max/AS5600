var lightboxFilePath = "https://widgets-ebscohost-com.ezproxy.uow.edu.au/prod/customlink/lightbox";
var lbWidget = 0;

var trackLBWidget = setInterval(function() {
    try {
        jQuery().jquery;
        clearInterval(trackLBWidget);
        LightBoxWidget();
    } catch (err) {}
}, 10);


function LightBoxWidget() {
    if (lbWidget == 1) {
        return;
    } else {
        lbWidget = 1;
    }

    jQuery('head').append('<link rel="stylesheet" type="text/css" href="' + lightboxFilePath + '/lib/jquery.fancybox.pack.css">');
    jQuery.ajax({
        url: lightboxFilePath + "/lib/jquery.fancybox.pack.js",
        dataType: "script",
        cache: true
    }).done(function() {});

    var linkSelectors = decodeURIComponent(jQuery('#lbwidget').data('select'));
    linkSelectors = linkSelectors.split(',');
    var iFrameDimensions = decodeURIComponent(jQuery('#lbwidget').data('dim'));
    iFrameDimensions = iFrameDimensions.split(',');

    LightboxApply(linkSelectors, iFrameDimensions);
    jQuery(document).ajaxComplete(function(a, b, c) { // Apply to links after ajax...
        //console.log(c);
        LightboxApply(linkSelectors, iFrameDimensions);
    });

    jQuery(window).resize(function() {
        jQuery.fancybox.update();
    });
}

function LightboxApply(linkSelectors, iFrameDimensions) {
    if (linkSelectors) {
        for (countSelector = 0; countSelector < linkSelectors.length; countSelector++) {
            linkSelectors[countSelector] = linkSelectors[countSelector].replace(/\+/g, ' ');
            jQuery(linkSelectors[countSelector]).each(function() {
                var hreftoCheck = jQuery(this).attr('href');
                if (hreftoCheck.indexOf('LightboxOpen') == -1) { // dont apply twice.
                    //console.log(hreftoCheck);
                    jQuery(this).attr('href', "javascript:LightboxOpen('" + encodeURIComponent(jQuery(this).attr('href')) + "', '" + iFrameDimensions[0] + "%', '" + iFrameDimensions[1] + "%')");
                    jQuery(this).attr('onclick', 'return true;');
                    jQuery(this).removeAttr('target');
                }
            });
        }
    }
}

function LightboxOpen(lbURL, lbW, lbH) {
    parent.jQuery.fancybox.open({
        href: lbURL,
        type: 'iframe',
        'width': lbW,
        'height': lbH,
        helpers: {
            overlay: {
                locked: false
            }
        },
        beforeLoad: function() {
            try {
                LightboxDisableScroll();
            } catch (err) {}
        },
        afterClose: function() {
            try {
                LightboxEnableScroll();
            } catch (err) {}
        }
    });
}

function preventDefault(e) {
    e = e || window.event;
    if (e.preventDefault) e.preventDefault();
    e.returnValue = false;
}

function LightboxKeydown(e) {
    var lbKeys = [37, 38, 39, 40];
    for (var i = lbKeys.length; i--;) {
        if (e.keyCode === lbKeys[i]) {
            preventDefault(e);
            return;
        }
    }
}

function LightboxWheel(e) {
    preventDefault(e);
}

function LightboxDisableScroll() {
    if (window.addEventListener) {
        window.addEventListener('DOMMouseScroll', LightboxWheel, false);
    }
    window.onmousewheel = document.onmousewheel = LightboxWheel;
    document.onkeydown = LightboxKeydown;
}

function LightboxEnableScroll() {
    if (window.removeEventListener) {
        window.removeEventListener('DOMMouseScroll', LightboxWheel, false);
    }
    window.onmousewheel = document.onmousewheel = document.onkeydown = null;
}