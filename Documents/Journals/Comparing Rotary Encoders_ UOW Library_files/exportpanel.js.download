(function(a){var e=null;function d(){ep.debug("exportPanel:create");a("#ToolPanelContent").bind("panelReady",function(m,n){if(n==="export"){g();}});g();}function g(){ep.debug("exportPanel:initialize");f();i();j();}function f(){if(a("#exportDialog").is("form")){e=a("#exportDialog");}else{e=a("#aspnetForm");}}function i(){ep.debug("exportPanel:setevents");a("#exportDialog").bind("click",function(m){b(m);});a("#exportDialog ul").keydown(function(m){if(m.which==="32"){if(a(this).children().find("input:checked").parent().next().find("input:visible").length>0){a(this).children().find("input:checked").parent().next().find("input:visible").focus();}else{a(this).children().find("input:visible").first().focus();}}});}function b(n){var m=a(n.target);if(m.hasClass("export-save")&&!a("#exportDialog").hasClass("save-panel")){a("#exportDialog").addClass("save-panel");m.siblings("a").andSelf().toggleClass("highlighted color-p1 bg-p2");}else{if(m.hasClass("export-email")&&a("#exportDialog").hasClass("save-panel")){a("#exportDialog").removeClass("save-panel");m.siblings("a").andSelf().toggleClass("highlighted color-p1 bg-p2");}else{if(m.hasClass("button")){n.preventDefault();if(m.hasClass("export-panel-action")){h();}else{c();}}}}}function l(p,q,o,n){if(p!==null&&p!==undefined){var m=jQuery("<div class='displayModal note'></div>").html(p).dialog({autoOpen:false,title:q});if(o==="true"){m.dialog("option","buttons",[{text:"Cancel","class":"button primary-action",click:function(){jQuery(this).dialog("close");}},{text:"Continue","class":"button",click:n}]);}m.dialog({autoOpen:true,resizable:false,modal:true,height:80});}return false;}function k(m){a.ajax({url:m,type:"GET",success:function(o){if(o!==null&&o!==undefined&&o.ErrorMessage!==null){l(o.ErrorMessage,"","true",function(){a(this).dialog("close");if(o.RedirectUrl!==null){window.location=ep.utilities.replaceEPCommand(o.RedirectUrl);}});}else{if(o!==null&&o!==undefined&&o.FormActionUrl!==null){var n=a("<form>").attr({action:o.FormActionUrl,target:"_blank",method:"POST",style:"display:none"}).appendTo("body");a("<textarea>").attr({name:o.ExportDataContainerName,value:o.ExportText,style:"display:none"}).appendTo(n);n.submit();n.remove();}else{l(ep.clientData.ExportGenericError);}}},error:function(n){l(ep.clientData.ExportGenericError);},async:false});c();}function h(){var n=ep.utilities.buildRouteKey(ep.clientData.currentRecord.Db,ep.clientData.currentRecord.Term,ep.clientData.currentRecord.Tag);if(a("#exportDialog").hasClass("save-panel")){var o=a("#bibSaveFormat input:radio:checked").val();var m;if(o==="7"){m=ep.utilities.replaceEPCommand("easybibdirectexport/getexporttext/"+ep.utilities.urlSafeEncodeBase64(n));}else{m=ep.utilities.replaceEPCommand("delivery/ExportPanelSave/"+ep.utilities.urlSafeEncodeBase64(n));}m+="&theExportFormat="+o;if(o==="2"||o==="5"||o==="1"){window.open(m);c();}else{if(o==="7"){k(m);}else{window.location=m;c();}}return false;}else{if(!e.validate().form()){return;}a.ajax({url:ep.utilities.buildAjaxRequestPath("delivery/ExportPanelEmail",ep.clientData.currentRecord),type:"POST",data:a(".export-panel-email *").serialize(),success:function(p){a("#exportDialog").append(p);a(".confirm button").focus();}});}}function c(){a("#ToolPanelContent").trigger("panelClose","export");}function j(){e.data("validator",null);var m={};if(ep.messages&&ep.messages.field_required&&ep.messages.email_invalid_error){m={theEmailFrom:{required:ep.messages.field_required,email:ep.messages.email_invalid_error},theEmailTo:{required:ep.messages.field_required,multiemail:ep.messages.email_invalid_error}};}e.validate({rules:{theEmailFrom:{required:true,email:true},theEmailTo:{required:true,multiemail:true}},ignoreTitle:true,onfocusout:false,onsubmit:false,messages:m});}a(d);})(jQuery);